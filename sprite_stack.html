<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprite Stack Studio</title>
    <style>
        :root {
            --bg: #1a1a1a;
            --panel: #2d2d2d;
            --accent: #00adb5;
            --text: #eeeeee;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Sidebar & Controls --- */
        #sidebar {
            width: 300px;
            background: var(--panel);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #444;
            gap: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        label { font-size: 0.8rem; color: #aaa; }

        input[type="number"], input[type="color"] {
            background: #333;
            border: 1px solid #555;
            color: white;
            padding: 5px;
            width: 100%;
        }

        /* --- Main Canvas Area --- */
        #main-editor {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #111;
            position: relative;
        }

        #pixel-grid {
            image-rendering: pixelated;
            background-image: 
                linear-gradient(45deg, #222 25%, transparent 25%), 
                linear-gradient(-45deg, #222 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #222 75%), 
                linear-gradient(-45deg, transparent 75%, #222 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border: 2px solid #444;
            cursor: crosshair;
        }

        /* --- Preview Window --- */
        #preview-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 250px;
            height: 250px;
            background: var(--panel);
            border: 2px solid var(--accent);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #preview-canvas {
            flex-grow: 1;
            width: 100%;
            image-rendering: pixelated;
        }

        /* --- Layers List --- */
        #layers-list {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* Bottom layer at bottom */
            gap: 5px;
        }

        .layer-item {
            padding: 10px;
            background: #3d3d3d;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            border-radius: 4px;
        }

        .layer-item.active {
            border-left: 4px solid var(--accent);
            background: #4d4d4d;
        }

        button {
            background: var(--accent);
            border: none;
            color: white;
            padding: 8px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
        }

        button:hover { opacity: 0.9; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Sprite Stacker</h2>
    
    <div class="control-group">
        <label>Grid Size (NxN)</label>
        <input type="number" id="grid-size" value="16" min="8" max="64">
        <label>Stack Spacing (Height)</label>
        <input type="number" id="stack-spacing" value="2" min="1" max="10">
        <label>Brush Color</label>
        <input type="color" id="brush-color" value="#00adb5">
    </div>

    <hr style="width:100%; border: 0.5px solid #444;">

    <div id="layers-list"></div>
    
    <button onclick="addLayer()">Add New Layer</button>
</div>

<div id="main-editor">
    <canvas id="pixel-grid"></canvas>
    <div style="margin-top: 10px; color: #666;">Left Click: Draw | Right Click: Erase</div>

    <div id="preview-container">
        <div style="font-size: 10px; padding: 5px; color: var(--accent);">3D PREVIEW (Auto-rotate)</div>
        <canvas id="preview-canvas"></canvas>
    </div>
</div>

<script>
    const gridSizeInput = document.getElementById('grid-size');
    const spacingInput = document.getElementById('stack-spacing');
    const colorInput = document.getElementById('brush-color');
    const layersList = document.getElementById('layers-list');
    const mainCanvas = document.getElementById('pixel-grid');
    const previewCanvas = document.getElementById('preview-canvas');
    
    const ctx = mainCanvas.getContext('2d');
    const pCtx = previewCanvas.getContext('2d');

    let size = 16;
    let layers = []; // Array of ImageData objects
    let activeLayerIndex = 0;
    let rotation = 0;

    // Initialize
    function init() {
        size = parseInt(gridSizeInput.value);
        mainCanvas.width = 400;
        mainCanvas.height = 400;
        previewCanvas.width = 250;
        previewCanvas.height = 250;
        
        // Start with 3 blank layers
        layers = [];
        for(let i=0; i<3; i++) {
            layers.push(new Uint32Array(size * size).fill(0x00000000));
        }
        renderLayersList();
        drawEditor();
    }

    // --- Editor Logic ---
    function drawEditor() {
        ctx.clearRect(0, 0, mainCanvas.width, mainCanvas.height);
        const pixelSize = mainCanvas.width / size;
        const currentData = layers[activeLayerIndex];

        for (let i = 0; i < currentData.length; i++) {
            if (currentData[i] !== 0) {
                ctx.fillStyle = `#${(currentData[i] & 0xFFFFFF).toString(16).padStart(6, '0')}`;
                ctx.fillRect((i % size) * pixelSize, Math.floor(i / size) * pixelSize, pixelSize, pixelSize);
            }
        }
    }

    function paint(e) {
        const rect = mainCanvas.getBoundingClientRect();
        const x = Math.floor((e.clientX - rect.left) / (rect.width / size));
        const y = Math.floor((e.clientY - rect.top) / (rect.height / size));
        
        if (x >= 0 && x < size && y >= 0 && y < size) {
            const color = e.buttons === 1 ? parseInt(colorInput.value.replace('#', ''), 16) | 0xFF000000 : 0;
            layers[activeLayerIndex][y * size + x] = color;
            drawEditor();
        }
    }

    mainCanvas.addEventListener('mousedown', paint);
    mainCanvas.addEventListener('mousemove', (e) => { if(e.buttons > 0) paint(e); });
    mainCanvas.addEventListener('contextmenu', e => e.preventDefault());

    // --- Layer Management ---
    function addLayer() {
        layers.push(new Uint32Array(size * size).fill(0x00000000));
        activeLayerIndex = layers.length - 1;
        renderLayersList();
        drawEditor();
    }

    function renderLayersList() {
        layersList.innerHTML = '';
        layers.forEach((layer, index) => {
            const div = document.createElement('div');
            div.className = `layer-item ${index === activeLayerIndex ? 'active' : ''}`;
            div.innerHTML = `<span>Layer ${index + 1}</span> <small onclick="deleteLayer(${index})">âœ–</small>`;
            div.onclick = () => { activeLayerIndex = index; renderLayersList(); drawEditor(); };
            layersList.appendChild(div);
        });
    }

    function deleteLayer(index) {
        if(layers.length <= 1) return;
        layers.splice(index, 1);
        activeLayerIndex = Math.min(activeLayerIndex, layers.length - 1);
        renderLayersList();
        drawEditor();
    }

    // --- 3D Preview Rendering ---
    function updatePreview() {
        pCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        rotation += 0.02;
        const spacing = parseInt(spacingInput.value);
        
        const centerX = previewCanvas.width / 2;
        const centerY = previewCanvas.height / 2 + (layers.length * spacing) / 2;

        // Render each layer from bottom to top
        layers.forEach((layer, layerIdx) => {
            const layerOffset = layerIdx * spacing;
            
            for (let i = 0; i < layer.length; i++) {
                if (layer[i] === 0) continue;

                const x = (i % size) - size / 2;
                const y = Math.floor(i / size) - size / 2;

                // Rotation Math
                const rotX = x * Math.cos(rotation) - y * Math.sin(rotation);
                const rotY = (x * Math.sin(rotation) + y * Math.cos(rotation)) * 0.5; // Flatten for isometric look

                const screenX = centerX + rotX * 8;
                const screenY = centerY + rotY * 8 - layerOffset;

                pCtx.fillStyle = `#${(layer[i] & 0xFFFFFF).toString(16).padStart(6, '0')}`;
                pCtx.fillRect(screenX, screenY, 8, 8);
            }
        });

        requestAnimationFrame(updatePreview);
    }

    gridSizeInput.onchange = init;
    init();
    updatePreview();

</script>
</body>
</html>